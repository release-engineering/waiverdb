---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: functional-tests
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/tags: test,functional,integration
spec:
  description: >-
    Runs functional integration tests for WaiverDB using podman-compose
    to orchestrate the application container with PostgreSQL and Keycloak.

  params:
    - name: IMAGE_URL
      description: Fully qualified image name to test
      type: string
    - name: IMAGE_DIGEST
      description: Image digest to test
      type: string
    - name: SOURCE_ARTIFACT
      description: The Trusted Artifact URI pointing to the application source code
      type: string
      default: ""

  results:
    - name: TEST_OUTPUT
      description: Test output summary

  stepTemplate:
    env:
      - name: IMAGE_URL
        value: $(params.IMAGE_URL)
      - name: IMAGE_DIGEST
        value: $(params.IMAGE_DIGEST)
      - name: SOURCE_ARTIFACT
        value: $(params.SOURCE_ARTIFACT)

  steps:
    - name: use-trusted-artifact
      image: quay.io/redhat-appstudio/build-trusted-artifacts:latest@sha256:4e39fb97f4444c2946944482df47b39c5bbc195c54c6560b0647635f553ab23d
      args:
        - use
        - $(params.SOURCE_ARTIFACT)=/var/workdir/source
      volumeMounts:
        - name: workdir
          mountPath: /var/workdir

    - name: install-dependencies
      image: registry.access.redhat.com/ubi9/ubi:latest
      workingDir: /var/workdir/source
      script: |
        #!/bin/bash
        set -euo pipefail

        echo "Installing system dependencies..."
        dnf install -y \
          chromium \
          python3.13 \
          python3.13-pip \
          podman \
          git

        # Install uv for Python package management
        curl -LsSf https://astral.sh/uv/install.sh | sh
        export PATH="/root/.local/bin:$PATH"

        echo "Dependencies installed successfully"
      volumeMounts:
        - name: workdir
          mountPath: /var/workdir
      securityContext:
        runAsUser: 0

    - name: run-functional-tests
      image: registry.access.redhat.com/ubi9/ubi:latest
      workingDir: /var/workdir/source
      script: |
        #!/bin/bash
        set -euo pipefail

        export PATH="/root/.local/bin:$PATH"

        # Use the built image for testing
        IMAGE_WITH_DIGEST="${IMAGE_URL}@${IMAGE_DIGEST}"
        echo "Testing image: ${IMAGE_WITH_DIGEST}"

        # Update docker-compose.yml to use the built image
        sed -i "s| build: .*| image: ${IMAGE_WITH_DIGEST}|" docker-compose.yml
        echo "Updated docker-compose.yml:"
        grep -E " image:| build: " docker-compose.yml

        # Setup cleanup trap
        cleanup() {
          echo "Cleaning up containers..."
          uvx --with podman-compose podman-compose down || true
        }
        trap cleanup EXIT

        # Pull required images
        echo "Pulling images with podman-compose..."
        uvx --with podman-compose podman-compose --verbose pull

        # Start services
        echo "Starting services with podman-compose..."
        uvx --with podman-compose podman-compose --verbose up --no-build -d

        # Run functional tests
        echo "Running functional tests..."
        uvx --with tox-uv tox -e functional -- --driver=Chrome

        echo "Functional tests completed successfully"
      volumeMounts:
        - name: workdir
          mountPath: /var/workdir
      securityContext:
        runAsUser: 0
        # Required for podman to create containers
        privileged: true

  volumes:
    - name: workdir
      emptyDir: {}
